
name: Update Multiple CourtListener Feeds

on:
  workflow_dispatch: {}
  schedule:
    - cron: "15 7 * * *"
    - cron: "15 13 * * *"

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    strategy:
      max-parallel: 1
      matrix:
        docket:
          # --- ORIGINAL (unchanged feed name for Newsdesk) ---
          - { id: "68024915", slug: "alter-v-openai-inc", file: "feed.xml", title: "Alter v. OpenAI, Inc." }

          # --- NEW SEPARATE FEEDS ---
          - { id: "69950497", slug: "tremblay-v-openai-inc", file: "feed-tremblay.xml", title: "Tremblay v. OpenAI, Inc." }
          - { id: "17131648", slug: "thomson-reuters-enterprise-centre-gmbh-v-ross-intelligence-inc", file: "feed-thomson-reuters-ross.xml", title: "Thomson Reuters v. ROSS Intelligence" }
          - { id: "67890942", slug: "huckabee-v-meta-platforms-inc", file: "feed-huckabee-meta.xml", title: "Huckabee v. Meta Platforms, Inc." }
          - { id: "67894459", slug: "concord-music-group-inc-v-anthropic-pbc", file: "feed-concord-anthropic.xml", title: "Concord Music Group v. Anthropic PBC" }
          - { id: "68117049", slug: "the-new-york-times-company-v-microsoft-corporation", file: "feed-nyt-microsoft.xml", title: "NYT v. Microsoft Corporation" }
          - { id: "68138737", slug: "basbanes-v-microsoft-corporation", file: "feed-basbanes-microsoft.xml", title: "Basbanes v. Microsoft Corporation" }
          - { id: "67810584", slug: "authors-guild-v-openai-inc", file: "feed-authors-guild-openai.xml", title: "Authors Guild v. OpenAI, Inc." }
          - { id: "67569326", slug: "kadrey-v-meta-platforms-inc", file: "feed-kadrey-meta.xml", title: "Kadrey v. Meta Platforms, Inc." }
          - { id: "67778017", slug: "chabon-v-openai-inc", file: "feed-chabon-openai.xml", title: "Chabon v. OpenAI, Inc." }
          - { id: "64928140", slug: "Alvarez-Toledo-v-Tesla-inc", file: "Alvarez-Toledo-Tesla.xml", title: "Alvarez Toledo v. Tesla, Inc." }
          - { id: "65347117", slug: "In-Re-Tesla-Advanced-Driver-Assistance-Systems-Litigation", file: "In-Re-Tesla-Advanced-Driver-Assistance-Systems-Litigation.xml", title: "IN RE TESLA ADVANCED DRIVER ASSISTANCE SYSTEMS LITIGATION" }
          - { id: "69837833", slug: "Nyree-Hinton-v-Tesla-inc", file: "Nyree-Hinton-Tesla.xml", title: "Nyree Hinton Alvarez Toledo v. Tesla, Inc." }
          - { id: "67660386", slug: "Porter-v-Tesla-inc", file: "Porter-Tesla.xml", title: "Porter v. Tesla, Inc." }
          - { id: "68564538", slug: "Watkins-v-Musk", file: "Watkins-Musk.xml", title: "Watkins v. Musk" }
          - { id: "71021491", slug: "Monrand-v-Tesla-inc", file: "Morand-Tesla.xml", title: "Monrand v. Tesla, Inc." }
          - { id: "69799401", slug: "Brunner-v-Fenix-Internet-LLC", file: "Brunner-v-Fenix-Internet.xml", title: "Brunner v. Fenix Internet, LLC" }
          - { id: "69417248", slug: "Laborers-Local-235-Pension-Fund-v-Rentokil-Initial-PLC", file: "Laborers-Local-235-Pension-Fund-v-Rentokil-Initial.xml", title: "Laborers-Local-235-Pension-Fund-v-Rentokil-Initial" }
          - { id: "68990373", slug: "N.Z.-v-Fenix-International-Limited", file: "N.Z.-Fenix-International.xml", title: "N.Z. v. Fenix International Limited" }
          - { id: "68990373", slug: "McFadden-Fenix-Internet-LLC", file: "McFadden-Fenix Internet.xml", title: "McFadden-Fenix Internet" }
          - { id: "68082231", slug: "IN-RE:-Glucagon-like-Peptide-1 Receptor-Agonists-(GLP-1-RAs)-Products-LiabilityLitigation-(MDL-No.-3094)", file: "MDL-No.-3094.xml", title: "IN RE: Glucagon-like Peptide-1 Receptor Agonists (GLP-1 RAs) Products Liability Litigation (MDL No. 3094)"}


    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Build Atom feed for ${{ matrix.docket.title }}
        env:
          DOCKET_ID:     ${{ matrix.docket.id }}
          DOCKET_SLUG:   ${{ matrix.docket.slug }}
          FEED_SELF_URL: "https://michaellee50.github.io/CourtListener/${{ matrix.docket.file }}"
          FEED_TITLE:    ${{ matrix.docket.title }}   # optional cosmetic override
        run: |
          python scripts/build_feed.py
          # Only rename if the destination differs from feed.xml
          if [ "${{ matrix.docket.file }}" != "feed.xml" ]; then
            mv feed.xml "${{ matrix.docket.file }}"
          else
            echo "feed.xml already correct name; no rename needed."
          fi

      - name: Commit if changed (stash → rebase → push)
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # Stage adds + deletes (feed.xml -> feed-*.xml)
            git add -A
            git commit -m "Auto-update ${{ matrix.docket.file }}"

            # Make rebase safe, then push
            git stash --include-untracked
            git pull --rebase origin "${{ github.ref_name }}"
            git stash pop || true

            git push origin "${{ github.ref_name }}"
          else
            echo "No changes to commit."
          fi
